<!doctype html>
<html lang="en">

<head>
    <title>AI Counter</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <style>
        #image {
            width: 100%;
        }

        #data_smp {
            display: none;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand navbar-light bg-light">
        <div class="container-fluid">
            <div class="col-1"></div>
            <div class="col-11">
                <ul class="nav navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="view1.html">Maguwo Utara</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="view2.html">Maguwo Timur</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="view3.html">Maguwo Barat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="view_ruas8.html">Maguwo Timur (ruas)</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mt-5 mb-2">
            <div class="col-8">
                <img src="" alt="" class="img-fluid" id="image">
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col">
                        <h3>Realtime Count</h3>
                        <h5>⬆️ IN : <span id="smp_in">0</span> (SMP/menit)</h5>

                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>SM</th>
                                    <th>MP</th>
                                    <th>KS</th>
                                    <th>TB</th>
                                    <th>BB</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="sm_in">0</td>
                                    <td id="mp_in">0</td>
                                    <td id="ks_in">0</td>
                                    <td id="tb_in">0</td>
                                    <td id="bb_in">0</td>
                                </tr>
                            </tbody>
                        </table>

                        <h5>⬇️ OUT: <span id="smp_out">0</span> (SMP/menit)</h5>

                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>SM</th>
                                    <th>MP</th>
                                    <th>KS</th>
                                    <th>TB</th>
                                    <th>BB</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="sm_out">0</td>
                                    <td id="mp_out">0</td>
                                    <td id="ks_out">0</td>
                                    <td id="tb_out">0</td>
                                    <td id="bb_out">0</td>
                                </tr>
                            </tbody>
                        </table>

                        <p id="data_smp"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <h3>Historical Count</h3>
                        <!-- <h5>Average : <span id="smp_in">0</span> (SMP/menit)</h5> -->
                        <h5>Total : <span id="smp_sum">0</span> (SMP/jam)</h5>

                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>SM</th>
                                    <th>MP</th>
                                    <th>KS</th>
                                    <th>TB</th>
                                    <th>BB</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="sm_sum">0</td>
                                    <td id="mp_sum">0</td>
                                    <td id="ks_sum">0</td>
                                    <td id="tb_sum">0</td>
                                    <td id="bb_sum">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <h3>Kinerja Ruas</h3>
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th rowspan="2">SMP <sub>/jam</sub></th>
                                    <th rowspan="2">C <sub>0</sub></th>
                                    <th colspan="4" class="text-center">Faktor koreksi</th>
                                    <th rowspan="2">C</th>
                                    <th rowspan="2">D <sub>J</sub></th>
                                </tr>
                                <tr>
                                    
                                    
                                    <th>FC <sub>LJ</sub></th>
                                    <th>FC <sub>PA</sub></th>
                                    <th>FC <sub>HS</sub></th>
                                    <th>FC <sub>UK</sub></th>
                                    
                                    
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="smp_total">0.0</td>
                                    <td id="nilai_c_0">0.0</td>
                                    <td id="nilai_fc_lj">0.0</td>
                                    <td id="nilai_fc_pa">0.0</td>
                                    <td id="nilai_fc_hs">0.0</td>
                                    <td id="nilai_fc_uk">0.0</td>
                                    <td id="nilai_c">0.0</td>
                                    <td id="nilai_d_j">0.0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <div class="row">
            <div class="col">
                <h3>pengaturan variabel kapasitas ruas</h3>
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">tipe jalan</label>
                <select class="form-select" name="tipe_jalan" id="tipe_jalan">
                    <option value='searah'>searah</option>
                    <option value='1/1'>1/1</option>
                    <option value='2/1'>2/1</option>
                    <option value='2/2-t'>2/2-t</option>
                    <option value='2/2-tt'>2/2-tt</option>
                    <option value='4/2-t'>4/2-t</option>
                    <option value='4/2-tt'>4/2-tt</option>
                    <option value='6/2-t'>6/2-t</option>
                    <option value='8/2-t'>8/2-t</option>
                </select>
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">lebar jalur efektif</label>
                <input type="text" class="form-control" name="lebar_jalur" id="lebar_jalur" />
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">pemisah arah</label>
                <select class="form-select" name="pemisah_arah" id="pemisah_arah">
                    <option value='50-50'>50-50</option>
                    <option value='55-45'>55-45</option>
                    <option value='60-40'>60-40</option>
                    <option value='65-35'>65-35</option>
                    <option value='70-30'>70-30</option>
                </select>
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">kelas hambatan samping</label>
                <select class="form-select" name="kelas_hambatan_samping" id="kelas_hambatan_samping">
                    <option value='sangat_rendah'>sangat_rendah</option>
                    <option value='rendah'>rendah</option>
                    <option value='sedang'>sedang</option>
                    <option value='tinggi'>tinggi</option>
                    <option value='sangat_tinggi'>sangat_tinggi</option>
                </select>
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">lebar bahu efektif</label>
                <input type="text" class="form-control" name="lebar_bahu_efektif" id="lebar_bahu_efektif" />
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">jenis jalan (bahu atau kereb)</label>
                <select class="form-select" name="jenis_bahu_atau_kereb" id="jenis_bahu_atau_kereb">
                    <option value='berbahu'>berbahu</option>
                    <option value='berkereb'>berkereb</option>
                </select>
            </div>
        </div>

        <div class="row mt-2 mb-2">
            <div class="col">
                <label for="" class="form-label">kelas ukuran kota</label>
                <select class="form-select" name="ukuran_kota" id="ukuran_kota">
                    <option value='sangat_kecil'>sangat_kecil</option>
                    <option value='kecil'>kecil</option>
                    <option value='sedang'>sedang</option>
                    <option value='besar'>besar</option>
                    <option value='sangat_besar'>sangat_besar</option>
                </select>
            </div>
        </div>

        <input type="hidden" class="form-control" name="id_" id="id_" />
        <div class="row mt-2 mb-5">
            <div class="col">
                <div class="d-grid gap-2">
                    <button type="button" name="simpan" id="simpan" class="btn btn-primary">
                        Simpan Pengaturan
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>

    <!-- Latest compiled and minified JS -->
    <script src="//code.jquery.com/jquery.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script src="c_ruas_dalam_kota.js"></script>

    <script src="hitung_smp.js"></script>

    <script>
        var tipeJalan = TIPE_JALAN['4/2-t'];
        var lebarJalurEfektif = 3.50;
        var pemisahanArah = '50-50'; // pembagian arah kendaraan 50% - 50%
        var kelasHambatanSamping = 'rendah'; // Daerah Permukiman, ada beberapa angkutan umum (angkutan kota).
        var lebarBahuEfektif = 3.0;
        var jenisBahuAtauKereb = 'berbahu';
        var ukuranKota = 'sedang';

        var volumeSMPperJamSaatIni = Math.floor(Math.random() * (1500 - 500 + 1)) + 500;

        var hasil_c_0 = 0.0
        var hasil_fc_lj = 0.0
        var hasil_fc_pa = 0.0
        var hasil_fc_hs = 0.0
        var hasil_fc_uk = 0.0
        var hasil_c = 0.0
        var hasil_d_j = 0.0

        function updateHitungan() {
            let hasil = hitung(
                tipeJalan,
                lebarJalurEfektif,
                pemisahanArah,
                kelasHambatanSamping,
                lebarBahuEfektif,
                jenisBahuAtauKereb,
                ukuranKota,
                volumeSMPperJamSaatIni
            )

            document.getElementById('nilai_c_0').innerText = Math.round((hasil.c_0 + Number.EPSILON) * 100) / 100
            document.getElementById('nilai_fc_lj').innerText = Math.round((hasil.fc_lj + Number.EPSILON) * 100) / 100
            document.getElementById('nilai_fc_pa').innerText = Math.round((hasil.fc_pa + Number.EPSILON) * 100) / 100
            document.getElementById('nilai_fc_hs').innerText = Math.round((hasil.fc_hs + Number.EPSILON) * 100) / 100
            document.getElementById('nilai_fc_uk').innerText = Math.round((hasil.fc_uk + Number.EPSILON) * 100) / 100
            document.getElementById('nilai_c').innerText = Math.round((hasil.c + Number.EPSILON) * 100) / 100
            document.getElementById('nilai_d_j').innerText = Math.round((hasil.d_j + Number.EPSILON) * 100) / 100

            hasil_c_0 = hasil.c_0
            hasil_fc_lj = hasil.fc_lj
            hasil_fc_pa = hasil.fc_pa
            hasil_fc_hs = hasil.fc_hs
            hasil_fc_uk = hasil.fc_uk
            hasil_c = hasil.c
            hasil_d_j = hasil.d_j

            console.log(hasil)
        }

        updateHitungan()

    </script>

    <script>
        const id = 8
        const id_ruas = 1

        // var nilai_smp_total = 0

        function wsDisplayImage() {
            // WebSocket connection
            // const ws2 = new WebSocket('ws://localhost:8081/');
            const ws2 = new WebSocket('ws://172.29.109.20:8081/');

            // Function to handle incoming WebSocket messages
            ws2.onmessage = function (event) {
                // Parse the received JSON data
                // console.log(event);
                const data = JSON.parse(event.data);

                // Check if the received message contains 'frame' data
                if (data['streams_cam' + id]) {
                    document.getElementById('image').src = 'data:image/jpeg;base64,' + data['streams_cam' + id];
                }
            }

            ws2.onerror = function () {
                wsDisplayImage()
            }
            ws2.onclose = function () {
                wsDisplayImage()
            }
        }

        function wsDisplayText() {
            // WebSocket connection
            // const ws = new WebSocket('ws://localhost:8080/');
            const ws = new WebSocket('ws://172.29.109.20:8080/');

            // Function to handle incoming WebSocket messages
            ws.onmessage = function (event) {
                // Parse the received JSON data
                // console.log(event);
                const data = JSON.parse(event.data);

                if (data.id_kamera) {
                    if (data.id_kamera == id) {
                        document.getElementById('data_smp').innerText = event.data

                        document.getElementById('smp_in').innerText = data.smp_in
                        document.getElementById('smp_out').innerText = data.smp_out

                        document.getElementById('sm_in').innerText = objekAiCount(data.objek_in, 'person') + objekAiCount(data.objek_in, 'motorcycle')
                        document.getElementById('mp_in').innerText = objekAiCount(data.objek_in, 'car')
                        document.getElementById('ks_in').innerText = objekAiCount(data.objek_in, 'truck') + objekAiCount(data.objek_in, 'bus')
                        document.getElementById('tb_in').innerText = 0.0
                        document.getElementById('bb_in').innerText = 0.0

                        document.getElementById('sm_out').innerText = objekAiCount(data.objek_out, 'person') + objekAiCount(data.objek_out, 'motorcycle')
                        document.getElementById('mp_out').innerText = objekAiCount(data.objek_out, 'car')
                        document.getElementById('ks_out').innerText = objekAiCount(data.objek_out, 'truck') + objekAiCount(data.objek_out, 'bus')
                        document.getElementById('tb_out').innerText = 0.0
                        document.getElementById('bb_out').innerText = 0.0
                    }
                }
            }

            ws.onerror = function () {
                wsDisplayText()
            }
            ws.onclose = function () {
                wsDisplayText()
            }
        }

        function objekAiCount(objek, nama) {
            let count = 0
            objek.forEach(obj => {
                if (obj.name == nama) {
                    count = obj.count
                }
            })
            return count
        }

        function getTotalSMPHour() {
            $.ajax('http://localhost:3000/average_last_hour/' + id, {
                success: (data, status) => {
                    if (data.result.length > 0) {
                        // console.log(data.result[0])
                        const sum_count = data.result[0]
                        document.getElementById('smp_sum').innerText = sum_count.smp_in + sum_count.smp_out
                        document.getElementById('sm_sum').innerText = sum_count.sm
                        document.getElementById('mp_sum').innerText = sum_count.mp
                        document.getElementById('ks_sum').innerText = sum_count.ks
                        document.getElementById('tb_sum').innerText = sum_count.tb
                        document.getElementById('bb_sum').innerText = sum_count.bb


                        updateHitungan()
                        volumeSMPperJamSaatIni = sum_count.smp_in + sum_count.smp_out
                        document.getElementById('smp_total').innerText = volumeSMPperJamSaatIni
                        // hasil_ds = volumeSMPperJamSaatIni / hasil_c
                        // if (volumeSMPperJamSaatIni < 1) {
                        //     hasil_ds = 0.0
                        // }
                        // document.getElementById('nilai_ds').innerText = Math.round((hasil_ds + Number.EPSILON) * 100) / 100
                    }
                }
            })
        }

        function getDataRuas() {
            document.getElementById('simpan').onclick = insertRuasData
            $.ajax('http://localhost:3000/ruas_data/' + id_ruas, {
                success: (data, status) => {
                    if (data.result.length > 0) {
                        // console.log(data.result[0])
                        const dataRuas = data.result[0]

                        document.getElementById('tipe_jalan').value = dataRuas.tipe_jalan
                        document.getElementById('lebar_jalur').value = dataRuas.lebar_jalur
                        document.getElementById('pemisah_arah').value = dataRuas.pemisah_arah
                        document.getElementById('kelas_hambatan_samping').value = dataRuas.kelas_hambatan_samping
                        document.getElementById('lebar_bahu_efektif').value = dataRuas.lebar_bahu_efektif
                        document.getElementById('jenis_bahu_atau_kereb').value = dataRuas.jenis_bahu_atau_kereb
                        document.getElementById('ukuran_kota').value = dataRuas.ukuran_kota

                        document.getElementById('simpan').onclick = updateRuasData

                        tipeJalan = dataRuas.tipe_jalan
                        lebarJalurEfektif = dataRuas.lebar_jalur
                        pemisahanArah = dataRuas.pemisah_arah
                        kelasHambatanSamping = dataRuas.kelas_hambatan_samping
                        lebarBahuEfektif = dataRuas.lebar_bahu_efektif
                        jenisBahuAtauKereb = dataRuas.jenis_bahu_atau_kereb
                        ukuranKota = dataRuas.ukuran_kota

                        updateHitungan()
                    }
                }
            })
        }

        function insertRuasData() {
            const data = {
                id_ruas: id_ruas,
                tipe_jalan: document.getElementById('tipe_jalan').value,
                lebar_jalur: document.getElementById('lebar_jalur').value,
                pemisah_arah: document.getElementById('pemisah_arah').value,
                kelas_hambatan_samping: document.getElementById('kelas_hambatan_samping').value,
                lebar_bahu_efektif: document.getElementById('lebar_bahu_efektif').value,
                jenis_bahu_atau_kereb: document.getElementById('jenis_bahu_atau_kereb').value,
                ukuran_kota: document.getElementById('ukuran_kota').value,
            }
            // http://localhost:3000/tabel/simpang/insert?nama=tajem%20utara&lat=176.168
            document.getElementById('simpan').disabled = true
            document.getElementById('simpan').innerText = 'menyimpan...'
            let url = 'http://localhost:3000/tabel/ruas_data/insert?' + objectToQueryString(data)
            $.ajax(url, {
                success: (data, status) => {
                    document.getElementById('simpan').disabled = false
                    document.getElementById('simpan').innerText = 'simpan'
                    document.getElementById('simpan').onclick = updateRuasData
                    updateHitungan()
                },
                error: (xhr, status) => {
                    document.getElementById('simpan').disabled = false
                    document.getElementById('simpan').innerText = 'simpan'
                    document.getElementById('simpan').onclick = insertRuasData
                }
            })
        }

        function updateRuasData() {
            const id_ = document.getElementById('id_').value
            const data = {
                id_ruas: id_ruas,
                tipe_jalan: document.getElementById('tipe_jalan').value,
                lebar_jalur: document.getElementById('lebar_jalur').value,
                pemisah_arah: document.getElementById('pemisah_arah').value,
                kelas_hambatan_samping: document.getElementById('kelas_hambatan_samping').value,
                lebar_bahu_efektif: document.getElementById('lebar_bahu_efektif').value,
                jenis_bahu_atau_kereb: document.getElementById('jenis_bahu_atau_kereb').value,
                ukuran_kota: document.getElementById('ukuran_kota').value,
            }
            // http://localhost:3000/tabel/simpang/update/4?nama=tajem%20utara&lat=176.168
            document.getElementById('simpan').disabled = true
            document.getElementById('simpan').innerText = 'menyimpan...'
            let url = 'http://localhost:3000/tabel/ruas_data/update/' + id_ + '?' + objectToQueryString(data)
            $.ajax(url, {
                success: (data, status) => {
                    document.getElementById('simpan').disabled = false
                    document.getElementById('simpan').innerText = 'simpan'
                    document.getElementById('simpan').onclick = updateRuasData
                    updateHitungan()
                },
                error: (xhr, status) => {
                    document.getElementById('simpan').disabled = false
                    document.getElementById('simpan').innerText = 'simpan'
                    document.getElementById('simpan').onclick = insertRuasData
                }
            })
        }

        function objectToQueryString(obj) {
            const keyValuePairs = [];
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    keyValuePairs.push(encodeURIComponent(key) + '=' + encodeURIComponent(obj[key]));
                }
            }
            return keyValuePairs.join('&');
        }

        wsDisplayText()
        wsDisplayImage()
        getTotalSMPHour()
        getDataRuas()

        setInterval(() => {
            getTotalSMPHour()
        }, 60 * 1000);
    </script>
</body>

</html>